<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>One-time link</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial;
  background: #f4f6f8;
  margin: 0;
}

.container {
  max-width: 720px;
  margin: 60px auto;
  background: #fff;
  padding: 32px;
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0,0,0,.08);
}

h1 {
  margin-top: 0;
  font-size: 22px;
}

.form-row {
  display: flex;
  gap: 10px;
}

input[type="text"] {
  padding: 12px 14px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  box-sizing: border-box;
}

input.main { flex: 1; }
input.client { max-width: 160px; }

#generatedLink {
  width: 100%;
  margin-top: 12px;
}

button {
  margin-top: 10px;
  padding: 12px;
  border-radius: 10px;
  border: none;
  background: #4f46e5;
  color: #fff;
  cursor: pointer;
}

.copy-btn {
  background: linear-gradient(135deg, #16a34a, #22c55e);
}

.history {
  margin-top: 30px;
}

.history-item {
  display: flex;
  align-items: flex-start;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 8px;
}

/* üî• –ê–ö–¢–ò–í–ù–ê–Ø –°–¢–†–û–ö–ê (OPENED –∏–ª–∏ USED) */
.row-active {
  background-color: #ecfdf5 !important;
  border-left: 4px solid #22c55e !important;
  padding-left: 10px;
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin-right: 10px;
  margin-top: 6px;
}

.status-new { background: #facc15; }    /* –∂—ë–ª—Ç–∞—è */
.status-opened { background: #22c55e; } /* –∑–µ–ª—ë–Ω–∞—è */
.status-used { background: #ef4444; }   /* –∫—Ä–∞—Å–Ω–∞—è */

.history-time {
  font-size: 12px;
  color: #6b7280;
}
</style>
</head>

<body>

<div class="container">
<h1>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏</h1>

<form method="post" action="/create">
  <div class="form-row">
    <input
      class="main"
      id="targetInput"
      name="target_url"
      placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É"
      required
    >

    <input
      class="client"
      name="client"
      placeholder="–ü–æ–ª–µ"
    >
  </div>

  <button type="submit">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
</form>

{% if link %}
<input id="generatedLink" value="{{ link }}" readonly>
<button class="copy-btn" onclick="copyLink()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
{% endif %}

<div class="history">
{% for code, item in links.items() %}
<div class="history-item {% if item.state == 'OPENED' or item.state == 'USED' %}row-active{% endif %}">

  <span class="status-dot
    {% if item.state == 'NEW' %}status-new
    {% elif item.state == 'OPENED' %}status-opened
    {% elif item.state == 'USED' %}status-used
    {% endif %}">
  </span>

  <div>
    <div>
      {{ request.base_url }}l/{{ code }}
      {% if item.client %} ‚Äî <b>{{ item.client }}</b>{% endif %}
    </div>

    <div class="history-time">
      –°–æ–∑–¥–∞–Ω–∞: {{ item.created_at }}
    </div>

    {% if item.opened_at %}
    <div class="history-time">
      –û—Ç–∫—Ä—ã—Ç–∞: {{ item.opened_at }}
    </div>
    {% endif %}
  </div>

</div>
{% endfor %}
</div>

</div>

<script>
function copyLink() {
  const i = document.getElementById("generatedLink");
  i.select();
  document.execCommand("copy");
}

/* üîÅ –ü–æ–¥–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ (–∑–µ–ª—ë–Ω—ã–µ) —Å—Å—ã–ª–∫–∏ –≤–≤–µ—Ä—Ö */
document.addEventListener("DOMContentLoaded", () => {
  const history = document.querySelector(".history");
  if (!history) return;

  const items = Array.from(history.querySelectorAll(".history-item"));

  const active = items.filter(i => i.classList.contains("row-active"));
  const inactive = items.filter(i => !i.classList.contains("row-active"));

  // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  history.innerHTML = "";

  // –°–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ (–≤ —Ç–æ–º –ø–æ—Ä—è–¥–∫–µ, –∫–∞–∫ –ø—Ä–∏—à–ª–∏)
  active.forEach(i => history.appendChild(i));

  // –ü–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
  inactive.forEach(i => history.appendChild(i));
});
</script>
<script>
function copyLink() {
  const input = document.getElementById("generatedLink");
  input.select();
  input.setSelectionRange(0, 99999);
  navigator.clipboard.writeText(input.value);
}

/* —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –¢–û–õ–¨–ö–û –í –≠–¢–û–ô –í–ö–õ–ê–î–ö–ï */
document.addEventListener("DOMContentLoaded", () => {
  const saved = localStorage.getItem("generated_link");
  if (saved) {
    document.getElementById("generatedLink").value = saved;
  }
});

/* –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º submit —Ñ–æ—Ä–º—ã */
document.querySelector("form").addEventListener("submit", () => {
  setTimeout(() => {
    const input = document.getElementById("generatedLink");
    if (input && input.value) {
      localStorage.setItem("generated_link", input.value);
    }
  }, 500);
});
</script>
  <script>
/* ========== –°–û–•–†–ê–ù–ï–ù–ò–ï –°–°–´–õ–ö–ò –í –†–ê–ú–ö–ê–• –í–ö–õ–ê–î–ö–ò ========== */

// –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ—ë
{% if link %}
sessionStorage.setItem("generatedLink", "{{ link }}");
{% endif %}

// –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¢–û–õ–¨–ö–û –¥–ª—è —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–∏
const savedLink = sessionStorage.getItem("generatedLink");
if (savedLink) {
  const field = document.getElementById("generatedLink");
  if (field) {
    field.value = savedLink;
  }
}

/* ========== –ö–û–ü–ò–†–û–í–ê–ù–ò–ï ========== */
function copyLink() {
  const input = document.getElementById("generatedLink");
  if (!input || !input.value) return;

  input.select();
  document.execCommand("copy");

  // –ª—ë–≥–∫–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
  input.style.background = "#dcfce7";
  setTimeout(() => {
    input.style.background = "";
  }, 300);
}
</script>
</body>
</html>


